@startuml
hide footbox

title Sequence Diagram: Create New Order

actor Customer
participant "UI: Checkout\nPage" as UI
participant "OrderService" as OS
participant "CartService" as CS
participant "Cart" as C
participant "CartItem" as CI
participant "Order" as O
participant "OrderItem" as OI
participant "DiscountService" as DS
participant "Discount" as D
participant "ProductService" as PS
participant "Product" as P
participant "PaymentService" as Payment
participant "EmailService" as ES

Customer -> UI: proceed to checkout from cart
activate UI
UI -> CS: getCartWithItems(customerId)
activate CS
CS -> C: findCartByCustomerId(customerId)
activate C
C --> CS: return Cart entity
deactivate C
CS -> CI: getCartItemsByCartId(cartId)
activate CI
CI --> CS: return list of CartItems
deactivate CI
CS --> UI: return cart with items and total
deactivate CS
UI -> Customer: display order summary and checkout form
deactivate UI

Customer -> UI: enter shipping address\nselect payment method\napply discount code (optional)
activate UI

alt Discount code applied
    Customer -> UI: enter discount code
    UI -> DS: validateDiscount(code, customerId)
    activate DS
    DS -> D: findActiveDiscountByCode(code)
    activate D
    D --> DS: return Discount details
    deactivate D
    DS -> D: checkValidity(date, maxUses)
    activate D
    D --> DS: return validation result
    deactivate D
    DS --> UI: return discount info and calculated savings
    deactivate DS
end

Customer -> UI: confirm order and payment

UI -> OS: createOrder(customerId, shippingAddress, \npaymentMethod, discountCode)
activate OS

OS -> CS: getCartForOrder(customerId)
activate CS
CS --> OS: return cart with items
deactivate CS

loop for each cart item
    OS -> PS: checkStockAvailability(productId, quantity)
    activate PS
    PS -> P: getStockQuantity()
    activate P
    P --> PS: return current stock
    deactivate P
    PS --> OS: return availability status
    deactivate PS
end

alt all items available
    OS -> OS: calculateOrderTotal(cartItems, discount)
    
    OS -> O: create Order entity
    activate O
    O --> OS: return Order object
    deactivate O
    
    loop for each cart item
        OS -> OI: create OrderItem(orderId, productId, quantity, unitPrice)
        activate OI
        OI --> OS: return saved OrderItem
        deactivate OI
        destroy OI
        
        OS -> PS: updateProductStock(productId, -quantity)
        activate PS
        PS -> P: decreaseStock(quantity)
        activate P
        P --> PS: stock updated
        deactivate P
        PS --> OS: stock decreased
        deactivate PS
    end
    
    alt discount applied
        OS -> DS: applyDiscount(orderId, discountCode)
        activate DS
        DS -> D: markDiscountAsUsed()
        activate D
        D --> DS: discount updated
        deactivate D
        destroy D
        DS --> OS: discount applied
        deactivate DS
    end
    
    OS -> Payment: processPayment(orderId, amount, paymentMethod)
    activate Payment
    Payment --> OS: return payment status
    deactivate Payment
    
    alt payment successful
        OS -> O: updateOrderStatus("CONFIRMED")
        activate O
        O --> OS: order updated
        deactivate O
        destroy O
        
        OS -> CS: clearCart(customerId)
        activate CS
        CS -> CI: deleteCartItems(cartId)
        activate CI
        CI --> CS: items deleted
        deactivate CI
        destroy CI
        CS --> OS: cart cleared
        deactivate CS
        destroy C
        
        OS -> ES: sendOrderConfirmation(customerId, orderId)
        activate ES
        ES --> OS: email sent
        deactivate ES
        
        OS --> UI: return order creation success\nwith order ID and confirmation
        deactivate OS
        UI -> Customer: display order confirmation\nwith tracking information
        deactivate UI
        
    else payment failed
        OS -> O: updateOrderStatus("PAYMENT_FAILED")
        activate O
        O --> OS: order updated
        deactivate O
        destroy O
        OS --> UI: return payment error
        deactivate OS
        UI -> Customer: display payment failure message
        deactivate UI
    end
    
else some items unavailable
    OS --> UI: return error "Some items are no longer available"
    deactivate OS
    UI -> Customer: display availability error\nwith list of unavailable items
    deactivate UI
    destroy UI
end

destroy Customer
@enduml
