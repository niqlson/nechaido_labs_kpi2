@startuml
hide footbox

title Sequence Diagram: Product Reservation with Admin Approval

actor Customer
actor Admin
participant "UI: Reservation\nPage" as UI
participant "ReservationService" as RS
participant "ReservationRepository" as RR
participant "Reservation" as R
participant "ReservationItem" as RI
participant "ProductService" as PS
participant "Product" as P
participant "NotificationService" as NS
participant "UI: Admin\nDashboard" as AdminUI

Customer -> UI: browse products and select product
activate UI
UI -> PS: getProductDetails(productId)
activate PS
PS -> P: findById(productId)
activate P
P --> PS: return Product details
deactivate P
PS --> UI: return Product info
deactivate PS

UI -> Customer: display product details and reservation form

Customer -> UI: fill reservation details and submit
UI -> RS: createReservation(customerId, productId, quantity, pickupDate)
activate RS

RS -> PS: checkProductAvailability(productId, quantity)
activate PS
PS -> P: getStockQuantity()
activate P
P --> PS: return current stock
deactivate P
PS --> RS: return availability status
deactivate PS

alt Product available
    RS -> RR: createNewReservation(customerId, pickupDate, "PENDING")
    activate RR
    RR -> R: save Reservation
    activate R
    R --> RR: return saved Reservation
    deactivate R
    RR --> RS: return reservation ID

    RS -> RR: addReservationItem(reservationId, productId, quantity)
    RR -> RI: save ReservationItem
    activate RI
    RI --> RR: return saved ReservationItem
    deactivate RI
    deactivate RR

    RS -> PS: reserveProductStock(productId, quantity)
    activate PS
    PS -> P: decreaseAvailableStock(quantity)
    activate P
    P --> PS: stock updated
    deactivate P
    PS --> RS: stock reserved
    deactivate PS

    RS -> NS: notifyAdminNewReservation(reservationId)
    activate NS
    NS --> RS: notification sent
    deactivate NS

    RS --> UI: return reservation submitted with pending status
else Product not available
    RS --> UI: return error "Product not available"
end
deactivate RS
UI -> Customer: display message
deactivate UI
destroy UI

Admin -> AdminUI: view pending reservations
activate AdminUI
AdminUI -> RS: getPendingReservations()
activate RS
RS -> RR: findReservationsByStatus("PENDING")
activate RR
RR --> RS: return list of pending reservations
deactivate RR
RS --> AdminUI: return reservations
deactivate RS
AdminUI -> Admin: display pending reservations

Admin -> AdminUI: select reservation for review
AdminUI -> RS: getReservationDetails(reservationId)
activate RS
RS -> RR: findReservationById(reservationId)
activate RR
RR --> RS: return Reservation with items
deactivate RR
RS --> AdminUI: return full reservation details
deactivate RS
AdminUI -> Admin: display reservation details

alt Admin decision
    Admin -> AdminUI: approve or reject
    AdminUI -> RS: updateReservationStatus(reservationId, status)
    activate RS
    RS -> RR: update Reservation entity
    activate RR
    RR -> R: setStatus(status)
    activate R
    R --> RR: reservation updated
    deactivate R
    RR --> RS: update confirmed
    deactivate RR

    RS -> PS: updateStock(reservationId, status)
    activate PS
    PS -> P: adjust stock quantity
    activate P
    P --> PS: stock updated
    deactivate P
    PS --> RS: stock adjustment done
    deactivate PS

    RS -> NS: notifyCustomer(reservationId, status)
    activate NS
    NS --> RS: notification sent
    deactivate NS

    RS --> AdminUI: return operation success
    deactivate RS
    AdminUI -> Admin: display confirmation
end
destroy AdminUI
@enduml
